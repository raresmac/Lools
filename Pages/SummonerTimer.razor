@page "/summoner-timer"
@using System.Threading
@implements IDisposable
@inject IJSRuntime JS

<div class="min-h-screen bg-slate-950 p-6 text-white font-sans overflow-x-auto">
    @if (Lanes == null || Spells == null || ChampionNames == null)
    {
        <div class="flex items-center justify-center h-screen">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
        </div>
    }
    else
    {
        <div class="max-w-[1800px] mx-auto pb-32">
            @* Header *@
            <div class="text-center mb-12">
                <h1 class="text-6xl font-black tracking-tighter italic text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-teal-400 to-blue-600 uppercase">
                    Summoner Tracker
                </h1>
                <div class="h-1 w-32 bg-blue-500 mx-auto mt-2 rounded-full shadow-[0_0_15px_#3b82f6]"></div>
            </div>

            @* Grid *@
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-8">
                @foreach (var lane in Lanes)
                {
                    <div class="bg-slate-900 min-w-[250px] rounded-2xl overflow-hidden border border-slate-800 shadow-2xl flex flex-col transform transition-all @(IsTeamLocked ? "border-slate-700" : "hover:border-blue-500/30")">

                        @* Champion Photo *@
                        <div class="relative h-64 bg-slate-800 overflow-hidden border-b border-slate-700">
                            @{
                                var imgUrl = GetChampionImgUrl(lane.Champion);
                            }
                            @if (!string.IsNullOrWhiteSpace(imgUrl))
                            {
                                <img src="@imgUrl" class="w-full h-full object-cover object-top opacity-70 transition-opacity duration-700" alt="" />
                            }
                            <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent"></div>
                            <div class="absolute bottom-4 left-0 right-0 text-center">
                                <span class="text-sm font-black text-blue-400 uppercase tracking-[0.4em] drop-shadow-md">@lane.Name</span>
                                @if (IsTeamLocked && !string.IsNullOrWhiteSpace(lane.Champion))
                                {
                                    <div class="text-xs font-bold text-white mt-1 uppercase tracking-widest">@lane.Champion</div>
                                }
                            </div>
                        </div>

                        <div class="p-6 space-y-6 flex-grow">
                            @if (!IsTeamLocked)
                            {
                                @* --- SETUP PHASE UI --- *@
                                <div>
                                    <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Champion</label>
                                    <input type="text" list="champion-list" placeholder="Select..."
                                           @bind="lane.Champion" @bind:event="oninput"
                                           class="w-full bg-slate-950 border border-slate-700 text-white px-4 py-2 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none" />
                                </div>

                                <div>
                                    <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Initial Haste (Runes)</label>
                                    <select @bind="lane.BaseHaste" class="w-full bg-slate-950 border border-slate-700 text-white text-xs px-3 py-2 rounded-xl outline-none">
                                        <option value="0">No Cosmic Insight (0)</option>
                                        <option value="10">Cosmic Insight (10)</option>
                                    </select>
                                </div>
                            }
                            else
                            {
                                @* --- LIVE PHASE: BOOTS BUTTON --- *@
                                <button @onclick="() => lane.HasIonianBoots = !lane.HasIonianBoots"
                                        class="w-full py-2 rounded-xl border-2 font-bold text-[10px] uppercase tracking-tighter transition-all @(lane.HasIonianBoots ? "bg-blue-600 border-blue-400 text-white shadow-[0_0_15px_rgba(59,130,246,0.5)]" : "bg-slate-950 border-slate-800 text-slate-500 hover:border-slate-600")">
                                    @(lane.HasIonianBoots ? "👟 Ionian Boots Active (+12)" : "🛒 Buy Ionian Boots")
                                </button>
                            }

                            @* --- SPELLS SECTION --- *@
                            <div class="grid grid-cols-1 gap-4">
                                @* Spell 1 Slot *@
                                <div class="relative group">
                                    @if (!IsTeamLocked)
                                    {
                                        <button @onclick="() => lane.IsFlashSwapped = !lane.IsFlashSwapped" class="absolute -top-2 -right-2 z-20 bg-slate-800 p-1 rounded-full border border-slate-700 text-slate-400 hover:text-blue-400"><svg class="w-3 h-3 rotate-45" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" /></svg></button>
                                        @if (lane.IsFlashSwapped)
                                        {
                                            <select @bind="lane.SelectedSpell1Key"
                                                    class="w-full bg-slate-800 text-white text-[10px] px-2 py-1 mb-2 rounded border @(string.IsNullOrEmpty(lane.SelectedSpell1Key) ? "border-red-500 animate-pulse" : "border-slate-700") uppercase font-bold">
                                                <option value="">Choose Spell</option>
                                                @foreach (var s in Spells.Where(kv => kv.Key != lane.SelectedSpell2Key))
                                                {
                                                    <option value="@s.Key">@s.Value.Name</option>
                                                }
                                            </select>
                                        }
                                    }

                                    @if (Spells.TryGetValue(lane.SelectedSpell1Key, out var s1))
                                    {
                                        <div class="relative h-20">
                                            @if (lane.Spell1Remaining.HasValue)
                                            {
                                                <button @onclick="() => lane.Spell1Remaining = null" class="absolute top-1 left-1 z-30 bg-red-600 rounded-md p-0.5 hover:bg-red-500 transition-colors shadow-lg">
                                                    <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" /></svg>
                                                </button>
                                            }
                                            <button @onclick="() => StartTimer(lane, true)" disabled="@(lane.Spell1Remaining.HasValue)"
                                                    class="w-full h-full relative overflow-hidden rounded-xl border-2 transition-all @(lane.Spell1Remaining.HasValue ? "border-slate-800 grayscale" : "border-yellow-500/30 hover:border-yellow-400 active:scale-95 shadow-lg")">
                                                <img src="@s1.IconUrl" class="absolute inset-0 w-full h-full object-cover opacity-20" />
                                                <div class="relative z-10 flex flex-col items-center justify-center h-full bg-slate-900/40">
                                                    @if (lane.Spell1Remaining.HasValue)
                                                    {
                                                        <span class="text-3xl font-black italic">@FormatTime(lane.Spell1Remaining)</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-[10px] font-black text-yellow-500 uppercase">@s1.Name</span>
                                                        <span class="text-[10px] font-bold text-slate-500">(@FormatTime(CalculateCd(s1.BaseCd, lane.TotalHaste)))</span>
                                                    }
                                                </div>
                                                @if (lane.Spell1Remaining.HasValue)
                                                {
                                                    <div class="absolute bottom-0 left-0 h-1.5 bg-yellow-500" style="width: @(GetPercent(lane.Spell1Remaining, CalculateCd(s1.BaseCd, lane.TotalHaste)))%"></div>
                                                }
                                            </button>
                                        </div>
                                    }
                                </div>

                                @* Spell 2 Slot *@
                                <div class="space-y-2">
                                    @if (!IsTeamLocked)
                                    {
                                        <select @bind="lane.SelectedSpell2Key" disabled="@(lane.Name == "Jungle")"
                                                class="w-full bg-slate-800 text-white text-[10px] px-2 py-1 rounded border @(string.IsNullOrEmpty(lane.SelectedSpell2Key) ? "border-red-500 animate-pulse" : "border-slate-700") uppercase font-bold disabled:opacity-50">
                                            @if (lane.Name != "Jungle")
                                            {
                                                <option value="">Choose Spell</option>
                                            }
                                            @foreach (var s in Spells.Where(kv => kv.Key != lane.SelectedSpell1Key))
                                            {
                                                <option value="@s.Key">@s.Value.Name</option>
                                            }
                                        </select>
                                    }

                                    @if (Spells.TryGetValue(lane.SelectedSpell2Key, out var s2))
                                    {
                                        <div class="relative h-20">
                                            @if (lane.Spell2Remaining.HasValue)
                                            {
                                                <button @onclick="() => lane.Spell2Remaining = null" class="absolute top-1 left-1 z-30 bg-red-600 rounded-md p-0.5 hover:bg-red-500 transition-colors shadow-lg">
                                                    <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" /></svg>
                                                </button>
                                            }
                                            <button @onclick="() => StartTimer(lane, false)" disabled="@(lane.Spell2Remaining.HasValue)"
                                                    class="w-full h-full relative overflow-hidden rounded-xl border-2 transition-all @(lane.Spell2Remaining.HasValue ? "border-slate-800 grayscale" : "border-blue-500/30 hover:border-blue-400 active:scale-95 shadow-lg")">
                                                <img src="@s2.IconUrl" class="absolute inset-0 w-full h-full object-cover opacity-20" />
                                                <div class="relative z-10 flex flex-col items-center justify-center h-full bg-slate-900/40">
                                                    @if (lane.Spell2Remaining.HasValue)
                                                    {
                                                        <span class="text-3xl font-black italic">@FormatTime(lane.Spell2Remaining)</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="text-[10px] font-black text-blue-400 uppercase">@s2.Name</span>
                                                        <span class="text-[10px] font-bold text-slate-500">(@FormatTime(CalculateCd(s2.BaseCd, lane.TotalHaste)))</span>
                                                    }
                                                </div>
                                                @if (lane.Spell2Remaining.HasValue)
                                                {
                                                    <div class="absolute bottom-0 left-0 h-1.5 bg-blue-500" style="width: @(GetPercent(lane.Spell2Remaining, CalculateCd(s2.BaseCd, lane.TotalHaste)))%"></div>
                                                }
                                            </button>
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>

            @* --- LOCK IN ACTION BAR --- *@
            <div class="mt-16 flex justify-center">
                @if (!IsTeamLocked)
                {
                    <button @onclick="ConfirmLock" class="px-12 py-4 bg-blue-600 hover:bg-blue-500 text-white rounded-2xl font-black uppercase tracking-[0.2em] shadow-[0_0_30px_rgba(59,130,246,0.4)] transition-all hover:scale-105 active:scale-95">
                        🔒 Lock In Match
                    </button>
                }
                else
                {
                    <button @onclick="() => IsTeamLocked = false" class="px-8 py-3 border border-slate-700 text-slate-500 hover:text-red-400 hover:border-red-400 rounded-xl font-bold uppercase text-xs transition-all">
                        🔓 Unlock Setup
                    </button>
                }
            </div>
        </div>
        <datalist id="champion-list">@foreach (var n in ChampionNames) {
        <option value="@n" />
    }
</datalist>
        }
</div>

@code {
    public class Spell { public string Name { get; set; } = ""; public int BaseCd { get; set; } public string IconUrl { get; set; } = ""; }
    public class LaneState
    {
        public string Name { get; set; } = "";
        public string Champion { get; set; } = "";
        public string SelectedSpell1Key { get; set; } = "flash";
        public string SelectedSpell2Key { get; set; } = "";
        public bool IsFlashSwapped { get; set; } = false;
        public int BaseHaste { get; set; } = 0;
        public bool HasIonianBoots { get; set; } = false;
        public int TotalHaste => BaseHaste + (HasIonianBoots ? 12 : 0);
        public int? Spell1Remaining { get; set; } = null;
        public int? Spell2Remaining { get; set; } = null;
    }

    private bool IsTeamLocked = false;
    private PeriodicTimer _timer = new PeriodicTimer(TimeSpan.FromSeconds(1));
    private CancellationTokenSource _cts = new();
    private List<LaneState> Lanes = new() { new LaneState { Name = "Top" }, new LaneState { Name = "Jungle", SelectedSpell2Key = "smite" }, new LaneState { Name = "Mid" }, new LaneState { Name = "Bot" }, new LaneState { Name = "Support" } };
    private Dictionary<string, Spell> Spells = new();
    private List<string> ChampionNames = new() { "Aatrox", "Ahri", "Akali", "Akshan", "Alistar", "Ambessa", "Amumu", "Anivia", "Annie", "Aphelios", "Ashe", "Aurelion Sol", "Aurora", "Azir", "Bard", "Bel'Veth", "Blitzcrank", "Brand", "Braum", "Briar", "Caitlyn", "Camille", "Cassiopeia", "Cho'Gath", "Corki", "Darius", "Diana", "Dr. Mundo", "Draven", "Ekko", "Elise", "Evelynn", "Ezreal", "Fiddlesticks", "Fiora", "Fizz", "Galio", "Gangplank", "Garen", "Gnar", "Gragas", "Graves", "Gwen", "Hecarim", "Heimerdinger", "Hwei", "Illaoi", "Irelia", "Ivern", "Janna", "Jarvan IV", "Jax", "Jayce", "Jhin", "Jinx", "K'Sante", "Kai'Sa", "Kalista", "Karma", "Karthus", "Kassadin", "Katarina", "Kayle", "Kayn", "Kennen", "Kha'Zix", "Kindred", "Kled", "Kog'Maw", "LeBlanc", "Lee Sin", "Leona", "Lillia", "Lissandra", "Lucian", "Lulu", "Lux", "Malphite", "Malzahar", "Maokai", "Master Yi", "Mel", "Milio", "Miss Fortune", "Mordekaiser", "Morgana", "Naafiri", "Nami", "Nasus", "Nautilus", "Neeko", "Nidalee", "Nilah", "Nocturne", "Nunu & Willump", "Olaf", "Orianna", "Ornn", "Pantheon", "Poppy", "Pyke", "Qiyana", "Quinn", "Rakan", "Rammus", "Rek'Sai", "Rell", "Renata Glasc", "Renekton", "Rengar", "Riven", "Rumble", "Ryze", "Samira", "Sejuani", "Senna", "Seraphine", "Sett", "Shaco", "Shen", "Shyvana", "Singed", "Sion", "Sivir", "Skarner", "Smolder", "Sona", "Soraka", "Swain", "Sylas", "Syndra", "Tahm Kench", "Taliyah", "Talon", "Taric", "Teemo", "Thresh", "Tristana", "Trundle", "Tryndamere", "Twisted Fate", "Twitch", "Udyr", "Urgot", "Varus", "Vayne", "Veigar", "Vel'Koz", "Vex", "Vi", "Viego", "Viktor", "Vladimir", "Volibear", "Warwick", "Wukong", "Xayah", "Xerath", "Xin Zhao", "Yasuo", "Yone", "Yorick", "Yuumi", "Zac", "Zed", "Zeri", "Ziggs", "Zilean", "Zoe", "Zyra" };

    protected override void OnInitialized()
    {
        string GetIcon(string n) => $"https://ddragon.leagueoflegends.com/cdn/14.1.1/img/spell/Summoner{n}.png";
        Spells = new Dictionary<string, Spell> { { "flash", new Spell { Name = "Flash", BaseCd = 300, IconUrl = GetIcon("Flash") } }, { "teleport", new Spell { Name = "Teleport", BaseCd = 360, IconUrl = GetIcon("Teleport") } }, { "ignite", new Spell { Name = "Ignite", BaseCd = 180, IconUrl = GetIcon("Dot") } }, { "heal", new Spell { Name = "Heal", BaseCd = 240, IconUrl = GetIcon("Heal") } }, { "exhaust", new Spell { Name = "Exhaust", BaseCd = 210, IconUrl = GetIcon("Exhaust") } }, { "ghost", new Spell { Name = "Ghost", BaseCd = 210, IconUrl = GetIcon("Haste") } }, { "smite", new Spell { Name = "Smite", BaseCd = 90, IconUrl = GetIcon("Smite") } }, { "barrier", new Spell { Name = "Barrier", BaseCd = 180, IconUrl = GetIcon("Barrier") } }, { "cleanse", new Spell { Name = "Cleanse", BaseCd = 210, IconUrl = GetIcon("Boost") } } };
        _ = RunTimer();
    }

    private async Task ConfirmLock()
    {
        // 1. Validation check: Ensure both spells are selected for all 5 lanes
        var incompleteLanes = Lanes.Where(l => string.IsNullOrEmpty(l.SelectedSpell1Key) || string.IsNullOrEmpty(l.SelectedSpell2Key)).ToList();

        if (incompleteLanes.Any())
        {
            var names = string.Join(", ", incompleteLanes.Select(l => l.Name));
            // We still keep the alert for missing spells as requested previously
            await JS.InvokeVoidAsync("alert", $"⚠️ Missing summoner spells for: {names}. Please select both spells for all champions before locking in.");
            return;
        }

        // 2. Direct Lock: No more "confirm" prompt.
        IsTeamLocked = true;
    }

    private string GetChampionImgUrl(string name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "";

        // 1. Clean input: remove apostrophes, spaces, periods, and dashes
        string input = name.Replace("'", "").Replace(" ", "").Replace(".", "").Replace("-", "").ToLower().Trim();

        // 2. Map outliers
        var special = new Dictionary<string, string> {
            {"wukong", "MonkeyKing"}, {"monkeyking", "MonkeyKing"}, {"nunu", "Nunu"},
            {"renata", "Renata"}, {"renataglasc", "Renata"}, {"jarvan", "JarvanIV"},
            {"jarvan4", "JarvanIV"}, {"jarvaniv", "JarvanIV"}, {"leblanc", "Leblanc"},
            {"ksante", "Ksante"}, {"drmundo", "DrMundo"}, {"khazix", "Khazix"},
            {"kaisa", "Kaisa"}, {"velkoz", "Velkoz"}, {"chogath", "Chogath"},
            {"belveth", "Belveth"}
        };

        if (special.TryGetValue(input, out var mapped))
            return $"https://ddragon.leagueoflegends.com/cdn/img/champion/loading/{mapped}_0.jpg";

        // 3. Generic formatting for simple names (first letter capitalized)
        string pascal = char.ToUpper(input[0]) + input.Substring(1);
        return $"https://ddragon.leagueoflegends.com/cdn/img/champion/loading/{pascal}_0.jpg";
    }

    private async Task RunTimer() { try { while (await _timer.WaitForNextTickAsync(_cts.Token)) { bool changed = false; foreach (var l in Lanes) { if (l.Spell1Remaining > 0) { l.Spell1Remaining--; changed = true; } else if (l.Spell1Remaining == 0) { l.Spell1Remaining = null; changed = true; } if (l.Spell2Remaining > 0) { l.Spell2Remaining--; changed = true; } else if (l.Spell2Remaining == 0) { l.Spell2Remaining = null; changed = true; } } if (changed) await InvokeAsync(StateHasChanged); } } catch { } }
    private void StartTimer(LaneState lane, bool isSpell1) { if (isSpell1 && Spells.TryGetValue(lane.SelectedSpell1Key, out var s1)) lane.Spell1Remaining = CalculateCd(s1.BaseCd, lane.TotalHaste); else if (!isSpell1 && Spells.TryGetValue(lane.SelectedSpell2Key, out var s2)) lane.Spell2Remaining = CalculateCd(s2.BaseCd, lane.TotalHaste); }
    private int CalculateCd(int b, int h) => (int)Math.Round(b * (1 - h / 100.0));
    private double GetPercent(int? c, int m) => c.HasValue ? (c.Value / (double)m) * 100 : 0;
    private string FormatTime(int? s) => !s.HasValue ? "READY" : $"{s.Value / 60}:{s.Value % 60:D2}";
    public void Dispose() { _cts.Cancel(); _cts.Dispose(); _timer.Dispose(); }
}