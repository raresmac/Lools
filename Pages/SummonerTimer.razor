@page "/summoner-timer"
@using System.Threading
@implements IDisposable

<div class="min-h-screen bg-slate-950 p-6 text-white font-sans overflow-x-auto">
    @if (Lanes == null || Spells == null || ChampionNames == null)
    {
        <div class="flex items-center justify-center h-screen">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
        </div>
    }
    else
    {
        <div class="max-w-[1800px] mx-auto">
            <div class="text-center mb-12">
                <h1 class="text-6xl font-black tracking-tighter italic text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-teal-400 to-blue-600 uppercase">
                    Summoner Tracker
                </h1>
                <div class="h-1 w-32 bg-blue-500 mx-auto mt-2 rounded-full shadow-[0_0_15px_#3b82f6]"></div>
            </div>

            @* Grid with min-width logic *@
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-8">
                @foreach (var lane in Lanes)
                {
                    @* Added min-w-[250px] here *@
                    <div class="bg-slate-900 min-w-[250px] rounded-2xl overflow-hidden border border-slate-800 shadow-2xl flex flex-col transform transition-all hover:border-blue-500/30">

                        @* --- CHAMPION PHOTO HEADER --- *@
                        <div class="relative h-64 bg-slate-800 overflow-hidden border-b border-slate-700">
                            @{
                                var imgUrl = GetChampionImgUrl(lane.Champion);
                            }
                            @if (!string.IsNullOrWhiteSpace(imgUrl))
                            {
                                <img src="@imgUrl" class="w-full h-full object-cover object-top opacity-70 transition-opacity duration-700" alt="" />
                            }
                            else
                            {
                                <div class="flex items-center justify-center h-full">
                                    <svg class="w-16 h-16 text-slate-700" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08s5.97 1.09 6 3.08c-1.29 1.94-3.5 3.22-6 3.22z" /></svg>
                                </div>
                            }
                            <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-transparent to-transparent"></div>
                            <div class="absolute bottom-4 left-0 right-0 text-center">
                                <span class="text-sm font-black text-blue-400 uppercase tracking-[0.4em] drop-shadow-md">@lane.Name</span>
                            </div>
                        </div>

                        <div class="p-6 space-y-6 flex-grow">
                            @* --- CHAMPION INPUT --- *@
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Champion</label>
                                <input type="text" list="champion-list" placeholder="Select or Type..."
                                       @bind="lane.Champion" @bind:event="oninput"
                                       class="w-full bg-slate-950 border border-slate-700 text-white px-4 py-3 rounded-xl text-base focus:ring-2 focus:ring-blue-500 outline-none transition-all placeholder:text-slate-700" />
                            </div>

                            @* Haste Select *@
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase mb-2 block">Summoner Haste</label>
                                <select @bind="lane.Haste" class="w-full bg-slate-950 border border-slate-700 text-white text-sm px-3 py-3 rounded-xl outline-none appearance-none cursor-pointer hover:bg-slate-900 transition-colors">
                                    @foreach (var opt in HasteOptions)
                                    {
                                        <option value="@opt.Key">@opt.Value</option>
                                    }
                                </select>
                            </div>

                            @* --- SPELL BUTTONS --- *@
                            <div class="grid grid-cols-1 gap-4">

                                @* SPELL 1 (Flash Slot) *@
                                <div class="relative group">
                                    @* SWAP BUTTON (Rotated Arrow) *@
                                    <button @onclick="() => lane.IsFlashSwapped = !lane.IsFlashSwapped"
                                            class="absolute -top-2 -right-2 z-20 bg-slate-800 p-1.5 rounded-full border border-slate-700 text-slate-400 hover:text-blue-400 hover:border-blue-500 transition-all shadow-xl">
                                        <svg class="w-3 h-3 transform rotate-45" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4" /></svg>
                                    </button>

                                    @if (lane.IsFlashSwapped)
                                    {
                                        <select @bind="lane.SelectedSpell1Key" class="w-full bg-slate-800 text-white text-[11px] px-3 py-1 mb-2 rounded border border-slate-700 uppercase font-bold">
                                            @foreach (var spell in Spells)
                                            {
                                                <option value="@spell.Key">@spell.Value.Name</option>
                                            }
                                        </select>
                                    }

                                    @if (Spells.TryGetValue(lane.SelectedSpell1Key, out var s1))
                                    {
                                        <button @onclick="() => StartTimer(lane, true)"
                                                disabled="@(lane.Spell1Remaining.HasValue)"
                                                class="w-full h-20 relative overflow-hidden rounded-xl border-2 transition-all @(lane.Spell1Remaining.HasValue ? "border-slate-800 grayscale" : "border-yellow-500/30 hover:border-yellow-400 active:scale-95 shadow-lg")">
                                            <img src="@s1.IconUrl" class="absolute inset-0 w-full h-full object-cover opacity-20" />
                                            <div class="relative z-10 flex flex-col items-center justify-center h-full bg-slate-900/40">
                                                @if (lane.Spell1Remaining.HasValue)
                                                {
                                                    <span class="text-3xl font-black text-white italic">@FormatTime(lane.Spell1Remaining)</span>
                                                }
                                                else
                                                {
                                                    <span class="text-sm font-black text-yellow-500 uppercase tracking-widest">@s1.Name</span>
                                                    @* Preview Timer *@
                                                    <span class="text-[10px] font-bold text-slate-500">(@FormatTime(CalculateCd(s1.BaseCd, lane.Haste)))</span>
                                                }
                                            </div>
                                            @if (lane.Spell1Remaining.HasValue)
                                            {
                                                <div class="absolute bottom-0 left-0 h-1.5 bg-yellow-500 shadow-[0_0_15px_#eab308]"
                                                     style="width: @(GetPercent(lane.Spell1Remaining, CalculateCd(s1.BaseCd, lane.Haste)))%"></div>
                                            }
                                        </button>
                                    }
                                </div>

                                @* SPELL 2 (Selectable Slot) *@
                                <div class="space-y-3">
                                    <select @bind="lane.SelectedSpell2Key"
                                            disabled="@(lane.Name == "Jungle")"
                                            class="w-full bg-slate-800 text-white text-[11px] px-3 py-2 rounded-lg border border-slate-700 uppercase font-bold tracking-tight disabled:opacity-50">
                                        @if (lane.Name != "Jungle")
                                        {
                                            <option value="">Choose Second Spell</option>
                                        }
                                        @foreach (var spell in Spells)
                                        {
                                            <option value="@spell.Key">@spell.Value.Name</option>
                                        }
                                    </select>

                                    @if (!string.IsNullOrEmpty(lane.SelectedSpell2Key) && Spells.TryGetValue(lane.SelectedSpell2Key, out var s2))
                                    {
                                        <button @onclick="() => StartTimer(lane, false)"
                                                disabled="@(lane.Spell2Remaining.HasValue)"
                                                class="w-full h-20 relative overflow-hidden rounded-xl border-2 transition-all @(lane.Spell2Remaining.HasValue ? "border-slate-800 grayscale" : "border-blue-500/30 hover:border-blue-400 active:scale-95 shadow-lg")">
                                            <img src="@s2.IconUrl" class="absolute inset-0 w-full h-full object-cover opacity-20" />
                                            <div class="relative z-10 flex flex-col items-center justify-center h-full bg-slate-900/40">
                                                @if (lane.Spell2Remaining.HasValue)
                                                {
                                                    <span class="text-3xl font-black text-white italic">@FormatTime(lane.Spell2Remaining)</span>
                                                }
                                                else
                                                {
                                                    <span class="text-sm font-black text-blue-400 uppercase tracking-widest">@s2.Name</span>
                                                    @* Preview Timer *@
                                                    <span class="text-[10px] font-bold text-slate-500">(@FormatTime(CalculateCd(s2.BaseCd, lane.Haste)))</span>
                                                }
                                            </div>
                                            @if (lane.Spell2Remaining.HasValue)
                                            {
                                                <div class="absolute bottom-0 left-0 h-1.5 bg-blue-500 shadow-[0_0_15px_#3b82f6]"
                                                     style="width: @(GetPercent(lane.Spell2Remaining, CalculateCd(s2.BaseCd, lane.Haste)))%"></div>
                                            }
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>

        <datalist id="champion-list">
            @foreach (var name in ChampionNames)
            {
                <option value="@name" />
            }
        </datalist>
    }
</div>

@code {
    public class Spell { public string Name { get; set; } = ""; public int BaseCd { get; set; } public string IconUrl { get; set; } = ""; }

    public class LaneState
    {
        public string Name { get; set; } = "";
        public string Champion { get; set; } = "";
        public string SelectedSpell1Key { get; set; } = "flash"; // Default to flash
        public string SelectedSpell2Key { get; set; } = "";
        public bool IsFlashSwapped { get; set; } = false; // Toggle for the arrow button
        public int Haste { get; set; } = 0;
        public int? Spell1Remaining { get; set; } = null;
        public int? Spell2Remaining { get; set; } = null;
    }

    private PeriodicTimer _timer = new PeriodicTimer(TimeSpan.FromSeconds(1));
    private CancellationTokenSource _cts = new();

    private List<LaneState> Lanes = new() {
        new LaneState { Name = "Top" },
        new LaneState { Name = "Jungle", SelectedSpell2Key = "smite" }, // Mandatory Smite
        new LaneState { Name = "Mid" },
        new LaneState { Name = "Bot" },
        new LaneState { Name = "Support" }
    };

    private Dictionary<string, Spell> Spells = new();
    private Dictionary<int, string> HasteOptions = new() { { 0, "No Haste" }, { 10, "Cosmic Insight" }, { 12, "Ionian Boots" }, { 22, "Insight + Boots" } };

    private List<string> ChampionNames = new() { "Aatrox", "Ahri", "Akali", "Akshan", "Alistar", "Ambessa", "Amumu", "Anivia", "Annie", "Aphelios", "Ashe", "Aurelion Sol", "Aurora", "Azir", "Bard", "Bel'Veth", "Blitzcrank", "Brand", "Braum", "Briar", "Caitlyn", "Camille", "Cassiopeia", "Cho'Gath", "Corki", "Darius", "Diana", "Dr. Mundo", "Draven", "Ekko", "Elise", "Evelynn", "Ezreal", "Fiddlesticks", "Fiora", "Fizz", "Galio", "Gangplank", "Garen", "Gnar", "Gragas", "Graves", "Gwen", "Hecarim", "Heimerdinger", "Hwei", "Illaoi", "Irelia", "Ivern", "Janna", "Jarvan IV", "Jax", "Jayce", "Jhin", "Jinx", "K'Sante", "Kai'Sa", "Kalista", "Karma", "Karthus", "Kassadin", "Katarina", "Kayle", "Kayn", "Kennen", "Kha'Zix", "Kindred", "Kled", "Kog'Maw", "LeBlanc", "Lee Sin", "Leona", "Lillia", "Lissandra", "Lucian", "Lulu", "Lux", "Malphite", "Malzahar", "Maokai", "Master Yi", "Mel", "Milio", "Miss Fortune", "Mordekaiser", "Morgana", "Naafiri", "Nami", "Nasus", "Nautilus", "Neeko", "Nidalee", "Nilah", "Nocturne", "Nunu & Willump", "Olaf", "Orianna", "Ornn", "Pantheon", "Poppy", "Pyke", "Qiyana", "Quinn", "Rakan", "Rammus", "Rek'Sai", "Rell", "Renata Glasc", "Renekton", "Rengar", "Riven", "Rumble", "Ryze", "Samira", "Sejuani", "Senna", "Seraphine", "Sett", "Shaco", "Shen", "Shyvana", "Singed", "Sion", "Sivir", "Skarner", "Smolder", "Sona", "Soraka", "Swain", "Sylas", "Syndra", "Tahm Kench", "Taliyah", "Talon", "Taric", "Teemo", "Thresh", "Tristana", "Trundle", "Tryndamere", "Twisted Fate", "Twitch", "Udyr", "Urgot", "Varus", "Vayne", "Veigar", "Vel'Koz", "Vex", "Vi", "Viego", "Viktor", "Vladimir", "Volibear", "Warwick", "Wukong", "Xayah", "Xerath", "Xin Zhao", "Yasuo", "Yone", "Yorick", "Yuumi", "Zac", "Zed", "Zeri", "Ziggs", "Zilean", "Zoe", "Zyra" };

    protected override void OnInitialized() { InitializeSpells(); _ = RunTimer(); }

    private void InitializeSpells()
    {
        string GetIcon(string n) => $"https://ddragon.leagueoflegends.com/cdn/14.1.1/img/spell/Summoner{n}.png";
        Spells = new Dictionary<string, Spell> {
            { "flash", new Spell { Name = "Flash", BaseCd = 300, IconUrl = GetIcon("Flash") } },
            { "teleport", new Spell { Name = "Teleport", BaseCd = 360, IconUrl = GetIcon("Teleport") } },
            { "ignite", new Spell { Name = "Ignite", BaseCd = 180, IconUrl = GetIcon("Dot") } },
            { "heal", new Spell { Name = "Heal", BaseCd = 240, IconUrl = GetIcon("Heal") } },
            { "exhaust", new Spell { Name = "Exhaust", BaseCd = 210, IconUrl = GetIcon("Exhaust") } },
            { "ghost", new Spell { Name = "Ghost", BaseCd = 210, IconUrl = GetIcon("Haste") } },
            { "smite", new Spell { Name = "Smite", BaseCd = 90, IconUrl = GetIcon("Smite") } },
            { "barrier", new Spell { Name = "Barrier", BaseCd = 180, IconUrl = GetIcon("Barrier") } },
            { "cleanse", new Spell { Name = "Cleanse", BaseCd = 210, IconUrl = GetIcon("Boost") } }
        };
    }

    private string GetChampionImgUrl(string name)
    {
        if (string.IsNullOrWhiteSpace(name)) return "";
        string input = name.ToLower().Trim();
        var special = new Dictionary<string, string> { { "wukong", "MonkeyKing" }, { "monkey king", "MonkeyKing" }, { "nunu", "Nunu" }, { "renata", "Renata" }, { "renata glasc", "Renata" }, { "jarvan", "JarvanIV" }, { "jarvan iv", "JarvanIV" }, { "leblanc", "Leblanc" }, { "k'sante", "KSante" }, { "dr. mundo", "DrMundo" } };
        if (special.TryGetValue(input, out var mapped)) return $"https://ddragon.leagueoflegends.com/cdn/img/champion/loading/{mapped}_0.jpg";
        var parts = name.Split(new[] { ' ', '-', '.', '\'' }, StringSplitOptions.RemoveEmptyEntries);
        var pascal = string.Join("", parts.Select(p => p.Length <= 1 ? p.ToUpper() : char.ToUpper(p[0]) + p.Substring(1).ToLower()));
        if (pascal == "JarvanIv") pascal = "JarvanIV";
        return $"https://ddragon.leagueoflegends.com/cdn/img/champion/loading/{pascal}_0.jpg";
    }

    private async Task RunTimer()
    {
        try
        {
            while (await _timer.WaitForNextTickAsync(_cts.Token))
            {
                bool changed = false;
                foreach (var l in Lanes)
                {
                    if (l.Spell1Remaining > 0) { l.Spell1Remaining--; changed = true; }
                    else if (l.Spell1Remaining == 0) { l.Spell1Remaining = null; changed = true; }
                    if (l.Spell2Remaining > 0) { l.Spell2Remaining--; changed = true; }
                    else if (l.Spell2Remaining == 0) { l.Spell2Remaining = null; changed = true; }
                }
                if (changed) await InvokeAsync(StateHasChanged);
            }
        }
        catch { }
    }

    private void StartTimer(LaneState lane, bool isSpell1)
    {
        if (isSpell1 && Spells.TryGetValue(lane.SelectedSpell1Key, out var s1))
            lane.Spell1Remaining = CalculateCd(s1.BaseCd, lane.Haste);
        else if (!isSpell1 && Spells.TryGetValue(lane.SelectedSpell2Key, out var s2))
            lane.Spell2Remaining = CalculateCd(s2.BaseCd, lane.Haste);
    }

    private int CalculateCd(int baseCd, int haste) => (int)Math.Round(baseCd * (1 - haste / 100.0));
    private double GetPercent(int? curr, int max) => curr.HasValue ? (curr.Value / (double)max) * 100 : 0;
    private string FormatTime(int? s) => !s.HasValue ? "READY" : $"{s.Value / 60}:{s.Value % 60:D2}";
    public void Dispose() { _cts.Cancel(); _cts.Dispose(); _timer.Dispose(); }
}