@page "/summoner-timer"
@using System.Threading
@implements IDisposable
@inject IJSRuntime JS

<div class="min-h-screen bg-slate-950 p-2 md:p-6 text-white font-sans selection:bg-blue-500/30 relative overflow-x-hidden" @onclick="HandleGlobalClick">
    @if (Lanes == null || Spells == null || ChampionNames == null)
    {
        <div class="flex items-center justify-center h-screen">
            <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500"></div>
        </div>
    }
    else
    {
        @* --- 1. FLOATING HUD (TOP CENTERED) --- *@
        <div class="fixed top-4 md:top-8 left-1/2 -translate-x-1/2 z-50 flex flex-col items-center pointer-events-none w-screen px-4">
            @if (!IsTeamLocked)
            {
                <button @onclick="ConfirmLock" @onclick:stopPropagation="true"
                        class="pointer-events-auto px-12 md:px-16 py-3 md:py-4 bg-blue-600 hover:bg-blue-500 text-white rounded-full font-black uppercase tracking-[0.3em] shadow-[0_0_50px_rgba(59,130,246,0.6)] transition-all hover:scale-105 active:scale-95 border-2 border-blue-400/30 text-xs md:text-sm">
                    🔒 Lock In Match
                </button>
            }
            else
            {
                <div class="pointer-events-auto bg-slate-900/95 backdrop-blur-2xl border border-slate-700/50 px-4 md:px-10 py-2 md:py-3 rounded-[2rem] md:rounded-full shadow-[0_30px_70px_rgba(0,0,0,0.8)] flex flex-col md:flex-row items-center justify-center gap-3 md:gap-8 min-w-[320px] md:min-w-0">

                    <div class="flex flex-row items-center gap-4 md:gap-8">
                        @* Blue Buff *@
                        <div class="flex items-center gap-2 md:gap-3">
                            <span class="text-[8px] md:text-[10px] font-black text-blue-500 uppercase tracking-widest text-center leading-tight">Blue<br />Buff</span>
                            <button @onclick="() => StartBuffTimer(true)" @onclick:stopPropagation="true" disabled="@(BlueBuffRemaining > 0)"
                                    class="w-16 md:w-24 h-9 md:h-11 rounded-xl border-2 flex items-center justify-center transition-all @(BlueBuffRemaining > 0 ? "border-slate-800 bg-slate-950 text-slate-500" : "border-blue-500/40 bg-blue-500/5 hover:border-blue-400 text-blue-100")">
                                @if (BlueBuffRemaining > 0)
                                {
                                    <span class="text-sm md:text-xl font-mono font-black">@FormatTime(BlueBuffRemaining)</span>
                                }
                                else
                                {

                                    <div class="w-4 h-4 bg-blue-500 rounded-full blur-sm animate-pulse"></div>
                                }
                            </button>
                        </div>

                        @* Cannon Tracker (Updated Logic) *@
                        <div class="flex items-center gap-2 md:gap-3 bg-slate-950/50 px-3 py-1.5 rounded-2xl border border-yellow-500/20">
                            <div class="text-center">
                                <span class="block text-[8px] md:text-[10px] font-black text-yellow-500 uppercase leading-none">Next</span>
                                <span class="block text-[8px] md:text-[10px] font-black text-yellow-500 uppercase leading-none">Cannon</span>
                            </div>
                            <span class="text-lg md:text-2xl font-mono font-black text-yellow-100 min-w-[50px] md:min-w-[70px] text-center">@FormatTime(GetNextCannonTime())</span>
                        </div>

                        @* Red Buff *@
                        <div class="flex items-center gap-2 md:gap-3">
                            <button @onclick="() => StartBuffTimer(false)" @onclick:stopPropagation="true" disabled="@(RedBuffRemaining > 0)"
                                    class="w-16 md:w-24 h-9 md:h-11 rounded-xl border-2 flex items-center justify-center transition-all @(RedBuffRemaining > 0 ? "border-slate-800 bg-slate-950 text-slate-500" : "border-red-500/40 bg-red-500/5 hover:border-red-400 text-red-100")">
                                @if (RedBuffRemaining > 0)
                                {
                                    <span class="text-sm md:text-xl font-mono font-black">@FormatTime(RedBuffRemaining)</span>
                                }
                                else
                                {

                                    <div class="w-4 h-4 bg-red-500 rounded-full blur-sm animate-pulse"></div>
                                }
                            </button>
                            <span class="text-[8px] md:text-[10px] font-black text-red-500 uppercase tracking-widest text-center leading-tight">Red<br />Buff</span>
                        </div>
                    </div>

                    @* Clock & Reset *@
                    <div class="flex items-center gap-4 md:gap-6 md:border-l border-slate-800/50 px-2 md:pl-8">
                        <button @onclick="RequestReset" @onclick:stopPropagation="true"
                                class="text-[8px] md:text-[10px] font-black uppercase transition-all px-3 md:px-5 py-1.5 md:py-2.5 rounded-full border @(ShowResetConfirm ? "text-white bg-red-600 border-red-400 animate-pulse shadow-[0_0_15px_#ef4444]" : "text-slate-500 border-slate-800 hover:text-red-400")">
                            @(ShowResetConfirm ? "CONFIRM?" : "RESET")
                        </button>
                        <div class="flex items-center gap-3 md:gap-4 bg-slate-950/80 px-4 md:px-8 py-1 md:py-2 rounded-xl md:rounded-2xl border border-blue-500/20 shadow-inner">
                            <button @onclick="() => MatchSeconds = Math.Max(0, MatchSeconds - 1)" @onclick:stopPropagation="true" class="text-2xl md:text-3xl text-blue-500/50 hover:text-blue-400 transition-all hover:scale-125">-</button>
                            <span class="text-3xl md:text-6xl font-mono font-black text-blue-50 text-shadow-glow min-w-[90px] md:min-w-[160px] text-center leading-none">@FormatTime(MatchSeconds)</span>
                            <button @onclick="() => MatchSeconds++" @onclick:stopPropagation="true" class="text-2xl md:text-3xl text-blue-500/50 hover:text-blue-400 transition-all hover:scale-125">+</button>
                        </div>
                    </div>
                </div>
            }
        </div>

        @* --- 2. CHAMPION GRID --- *@
        <div class="max-w-full mx-auto pt-44 md:pt-4 px-2 md:px-4 transition-all duration-300" id="tracker-container">
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-5 gap-4">
                @foreach (var lane in Lanes)
                {
                    <div class="bg-slate-900 w-full rounded-3xl overflow-hidden border border-slate-800 shadow-2xl flex flex-col transform transition-all duration-500 @(IsTeamLocked ? "border-slate-700 shadow-blue-900/10" : "hover:border-blue-500/30")">

                        @* Champion Portrait *@
                        <div class="relative transition-all duration-500 bg-slate-800 overflow-hidden border-b border-slate-700 @(IsTeamLocked ? "h-64 md:h-96" : "h-40 md:h-48")">
                            @{
                                var imgUrl = GetChampionImgUrl(lane.Champion);
                            }
                            @if (!string.IsNullOrWhiteSpace(imgUrl))
                            {
                                <img src="@imgUrl" class="w-full h-full object-cover object-top opacity-60" alt="" />
                            }
                            <div class="absolute inset-0 bg-gradient-to-t from-slate-900 via-slate-900/10 to-transparent"></div>
                            <div class="absolute bottom-4 left-0 right-0 text-center px-2">
                                <span class="text-2xl md:text-4xl font-black text-blue-400 uppercase tracking-[0.4em] drop-shadow-lg truncate">@lane.Name</span>
                                @if (IsTeamLocked && !string.IsNullOrWhiteSpace(lane.Champion))
                                {
                                    <div class="text-xl md:text-2xl font-black text-white mt-0 uppercase tracking-tighter italic truncate">@lane.Champion</div>
                                }
                            </div>
                        </div>

                        <div class="p-4 md:p-6 space-y-4 md:space-y-5 flex-grow">
                            @if (!IsTeamLocked)
                            {
                                <input type="text" list="champion-list" placeholder="Select Champion..."
                                       @bind="lane.Champion" @bind:event="oninput"
                                       class="w-full bg-slate-950 border border-slate-700 text-white px-4 py-2.5 rounded-xl text-sm outline-none focus:ring-2 focus:ring-blue-500 transition-all" />
                            }

                            @* HASTE TOGGLES *@
                            <div class="grid grid-cols-2 gap-2">
                                <button @onclick="() => lane.HasCosmicInsight = !lane.HasCosmicInsight" @onclick:stopPropagation="true"
                                        class="py-2 rounded-xl border-2 font-bold text-xs uppercase transition-all @(lane.HasCosmicInsight ? "bg-teal-600 border-teal-400 text-white shadow-[0_0_10px_#14b8a6]" : "bg-slate-950 border-slate-800 text-slate-500")">
                                    Cosmic
                                </button>
                                <button @onclick="() => lane.HasIonianBoots = !lane.HasIonianBoots" @onclick:stopPropagation="true"
                                        class="py-2 rounded-xl border-2 font-bold text-xs uppercase transition-all @(lane.HasIonianBoots ? "bg-blue-600 border-blue-400 text-white shadow-[0_0_10px_#3b82f6]" : "bg-slate-950 border-slate-800 text-slate-500")">
                                    Boots
                                </button>
                            </div>

                            @* ULTIMATE LOG *@
                            <div class="flex items-center gap-2">
                                <button @onclick="() => lane.UltLastUsed = MatchSeconds" @onclick:stopPropagation="true"
                                        class="flex-none px-4 py-2.5 rounded-xl border-2 border-purple-500/40 bg-purple-500/10 text-purple-300 font-black text-xs uppercase tracking-widest">
                                    ULT
                                </button>
                                <div class="flex-grow flex items-center justify-center bg-slate-950 border border-slate-800 rounded-xl p-1 h-10 md:h-11 shadow-inner">
                                    @if (lane.UltLastUsed.HasValue)
                                    {
                                        <button @onclick="() => lane.UltLastUsed = Math.Max(0, lane.UltLastUsed.Value - 1)" @onclick:stopPropagation="true" class="text-purple-500 hover:text-white font-bold text-2xl px-2">-</button>
                                        <span class="text-xl font-mono font-bold text-purple-200">@FormatTime(lane.UltLastUsed)</span>
                                        <button @onclick="() => lane.UltLastUsed++" @onclick:stopPropagation="true" class="text-purple-500 hover:text-white font-bold text-2xl px-2">+</button>
                                    }
                                    else
                                    {

                                        <span class="text-[10px] md:text-xs text-slate-700 uppercase font-black tracking-widest">Logged</span>
                                    }
                                </div>
                            </div>

                            @* SUMMONER SPELLS (Explicit Slot 1 & 2 Structure) *@
                            <div class="grid grid-cols-1 gap-4">
                                @* Slot 1 *@
                                <div class="space-y-1">
                                    @if (!IsTeamLocked)
                                    {
                                        <select @bind="lane.SelectedSpell1Key" @onclick:stopPropagation="true"
                                                class="w-full bg-slate-800 text-white text-[10px] px-2 py-1.5 rounded-lg border border-slate-700 uppercase font-bold outline-none">
                                            @foreach (var ds1 in Spells.Where(kv => kv.Key != lane.SelectedSpell2Key))
                                            {
                                                <option value="@ds1.Key">@ds1.Value.Name</option>
                                            }
                                        </select>
                                    }
                                    @if (Spells.TryGetValue(lane.SelectedSpell1Key, out var s1))
                                    {
                                        <div class="relative h-16 md:h-20">
                                            @if (lane.Spell1Remaining.HasValue)
                                            {
                                                <button @onclick="() => lane.Spell1Remaining = null" @onclick:stopPropagation="true" class="absolute -top-2 -left-2 z-40 bg-red-600 rounded-full p-1 shadow-xl">
                                                    <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" /></svg>
                                                </button>
                                                <div class="w-full h-full relative overflow-hidden rounded-2xl border-2 transition-all flex items-stretch @GetImminentClass(lane.Spell1Remaining)">
                                                    <img src="@s1.IconUrl" class="absolute inset-0 w-full h-full object-cover opacity-20" />
                                                    <button @onclick="() => AdjustSpell(lane, true, -1)" @onclick:stopPropagation="true" class="flex-1 z-10 text-5xl font-bold text-white/30 hover:text-white transition-all">-</button>
                                                    <div class="flex-[3] z-10 flex flex-col items-center justify-center pointer-events-none">
                                                        <span class="text-3xl md:text-5xl font-black italic tracking-tighter">@FormatTime(lane.Spell1Remaining)</span>
                                                        <span class="text-[8px] md:text-[9px] font-bold text-white/70 uppercase">@@ @FormatTime(lane.Spell1ReadyAt)</span>
                                                    </div>
                                                    <button @onclick="() => AdjustSpell(lane, true, 1)" @onclick:stopPropagation="true" class="flex-1 z-10 text-5xl font-bold text-white/30 hover:text-white transition-all">+</button>
                                                </div>
                                            }
                                            else
                                            {
                                                <button @onclick="() => StartTimer(lane, true)" @onclick:stopPropagation="true"
                                                        class="w-full h-full relative overflow-hidden rounded-2xl border-2 border-slate-800 bg-slate-900 hover:border-yellow-400 bg-slate-900/40 group transition-all">
                                                    <img src="@s1.IconUrl" class="absolute inset-0 w-full h-full object-cover opacity-20 group-hover:opacity-40" />
                                                    <div class="relative z-10 flex flex-col items-center justify-center h-full">
                                                        <span class="text-[10px] font-black text-yellow-500 uppercase tracking-widest">@s1.Name</span>
                                                        <span class="text-base md:text-lg font-mono font-bold text-white">@FormatTime(CalculateCd(s1.BaseCd, lane.TotalHaste))</span>
                                                    </div>
                                                </button>
                                            }
                                        </div>
                                    }
                                </div>

                                @* Slot 2 *@
                                <div class="space-y-1">
                                    @if (!IsTeamLocked)
                                    {
                                        <select @bind="lane.SelectedSpell2Key" @onclick:stopPropagation="true" disabled="@(lane.Name == "Jungle")"
                                                class="w-full bg-slate-800 text-white text-[10px] px-2 py-1.5 rounded-lg border border-slate-700 uppercase font-bold outline-none">
                                            @foreach (var ds2 in Spells.Where(kv => kv.Key != lane.SelectedSpell1Key))
                                            {
                                                <option value="@ds2.Key">@ds2.Value.Name</option>
                                            }
                                        </select>
                                    }
                                    @if (Spells.TryGetValue(lane.SelectedSpell2Key, out var s2))
                                    {
                                        <div class="relative h-16 md:h-20">
                                            @if (lane.Spell2Remaining.HasValue)
                                            {
                                                <button @onclick="() => lane.Spell2Remaining = null" @onclick:stopPropagation="true" class="absolute -top-2 -left-2 z-40 bg-red-600 rounded-full p-1 shadow-xl">
                                                    <svg class="w-3 h-3 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M6 18L18 6M6 6l12 12" /></svg>
                                                </button>
                                                <div class="w-full h-full relative overflow-hidden rounded-2xl border-2 transition-all flex items-stretch @GetImminentClass(lane.Spell2Remaining)">
                                                    <img src="@s2.IconUrl" class="absolute inset-0 w-full h-full object-cover opacity-20" />
                                                    <button @onclick="() => AdjustSpell(lane, false, -1)" @onclick:stopPropagation="true" class="flex-1 z-10 text-5xl font-bold text-white/30 hover:text-white transition-all">-</button>
                                                    <div class="flex-[3] z-10 flex flex-col items-center justify-center pointer-events-none">
                                                        <span class="text-3xl md:text-5xl font-black italic tracking-tighter">@FormatTime(lane.Spell2Remaining)</span>
                                                        <span class="text-[8px] md:text-[9px] font-bold text-white/70 uppercase">@@ @FormatTime(lane.Spell2ReadyAt)</span>
                                                    </div>
                                                    <button @onclick="() => AdjustSpell(lane, false, 1)" @onclick:stopPropagation="true" class="flex-1 z-10 text-5xl font-bold text-white/30 hover:text-white transition-all">+</button>
                                                </div>
                                            }
                                            else
                                            {
                                                <button @onclick="() => StartTimer(lane, false)" @onclick:stopPropagation="true"
                                                        class="w-full h-full relative overflow-hidden rounded-2xl border-2 border-slate-800 bg-slate-900 hover:border-blue-400 bg-slate-900/40 group transition-all">
                                                    <img src="@s2.IconUrl" class="absolute inset-0 w-full h-full object-cover opacity-20 group-hover:opacity-40" />
                                                    <div class="relative z-10 flex flex-col items-center justify-center h-full">
                                                        <span class="text-[10px] font-black text-blue-400 uppercase tracking-widest">@s2.Name</span>
                                                        <span class="text-base md:text-lg font-mono font-bold text-white">@FormatTime(CalculateCd(s2.BaseCd, lane.TotalHaste))</span>
                                                    </div>
                                                </button>
                                            }
                                        </div>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
        <datalist id="champion-list">@foreach (var n in ChampionNames) {
        <option value="@n" />
    }
</datalist>
        }
</div>

<style>
    .text-shadow-glow {
        text-shadow: 0 0 15px rgba(59, 130, 246, 0.6);
    }

    @@keyframes imminent-pulse {
        0%, 100% {
            opacity: 1;
        }

        50% {
            opacity: 0.7;
        }
    }

    .imminent-red {
        border-color: #ef4444 !important;
        box-shadow: 0 0 20px #ef4444;
        animation: imminent-pulse 0.5s infinite;
    }

    .imminent-yellow {
        border-color: #eab308 !important;
        box-shadow: 0 0 15px #eab308;
        animation: imminent-pulse 1s infinite;
    }

    body.sidebar-collapsed aside {
        width: 5rem !important;
        transition: width 0.3s ease;
    }

    body.sidebar-collapsed .sidebar-text {
        display: none !important;
    }

    body.sidebar-collapsed #tracker-container {
        max-width: 100vw;
        padding-left: 1rem;
        padding-right: 1rem;
    }
</style>

@code {
    public class Spell { public string Name { get; set; } = ""; public int BaseCd { get; set; } public string IconUrl { get; set; } = ""; }
    public class LaneState
    {
        public string Name { get; set; } = "";
        public string Champion { get; set; } = "";
        public string SelectedSpell1Key { get; set; } = "flash";
        public string SelectedSpell2Key { get; set; } = "";
        public bool HasCosmicInsight { get; set; } = false;
        public bool HasIonianBoots { get; set; } = false;
        public int TotalHaste => (HasCosmicInsight ? 18 : 0) + (HasIonianBoots ? 12 : 0);
        public int? Spell1Remaining { get; set; }
        public int? Spell1ReadyAt { get; set; }
        public int? Spell2Remaining { get; set; }
        public int? Spell2ReadyAt { get; set; }
        public int? UltLastUsed { get; set; }
    }

    private bool IsTeamLocked = false;
    private bool ShowResetConfirm = false;
    private int MatchSeconds = 0;
    private int? BlueBuffRemaining;
    private int? RedBuffRemaining;
    private CancellationTokenSource _cts = new();
    private CancellationTokenSource? _confirmCts;
    private List<LaneState> Lanes = new() { new LaneState { Name = "Top" }, new LaneState { Name = "Jungle", SelectedSpell2Key = "smite" }, new LaneState { Name = "Mid" }, new LaneState { Name = "Bot" }, new LaneState { Name = "Support" } };
    private Dictionary<string, Spell> Spells = new();
    private List<string> ChampionNames = new() { "Aatrox", "Ahri", "Akali", "Akshan", "Alistar", "Ambessa", "Amumu", "Anivia", "Annie", "Aphelios", "Ashe", "Aurelion Sol", "Aurora", "Azir", "Bard", "Bel'Veth", "Blitzcrank", "Brand", "Braum", "Briar", "Caitlyn", "Camille", "Cassiopeia", "Cho'Gath", "Corki", "Darius", "Diana", "Dr. Mundo", "Draven", "Ekko", "Elise", "Evelynn", "Ezreal", "Fiddlesticks", "Fiora", "Fizz", "Galio", "Gangplank", "Garen", "Gnar", "Gragas", "Graves", "Gwen", "Hecarim", "Heimerdinger", "Hwei", "Illaoi", "Irelia", "Ivern", "Janna", "Jarvan IV", "Jax", "Jayce", "Jhin", "Jinx", "K'Sante", "Kai'Sa", "Kalista", "Karma", "Karthus", "Kassadin", "Katarina", "Kayle", "Kayn", "Kennen", "Kha'Zix", "Kindred", "Kled", "Kog'Maw", "LeBlanc", "Lee Sin", "Leona", "Lillia", "Lissandra", "Lucian", "Lulu", "Lux", "Malphite", "Malzahar", "Maokai", "Master Yi", "Mel", "Milio", "Miss Fortune", "Mordekaiser", "Morgana", "Naafiri", "Nami", "Nasus", "Nautilus", "Neeko", "Nidalee", "Nilah", "Nocturne", "Nunu & Willump", "Olaf", "Orianna", "Ornn", "Pantheon", "Poppy", "Pyke", "Qiyana", "Quinn", "Rakan", "Rammus", "Rek'Sai", "Rell", "Renata Glasc", "Renekton", "Rengar", "Riven", "Rumble", "Ryze", "Samira", "Sejuani", "Senna", "Seraphine", "Sett", "Shaco", "Shen", "Shyvana", "Singed", "Sion", "Sivir", "Skarner", "Smolder", "Sona", "Soraka", "Swain", "Sylas", "Syndra", "Tahm Kench", "Taliyah", "Talon", "Taric", "Teemo", "Thresh", "Tristana", "Trundle", "Tryndamere", "Twisted Fate", "Twitch", "Udyr", "Urgot", "Varus", "Vayne", "Veigar", "Vel'Koz", "Vex", "Vi", "Viego", "Viktor", "Vladimir", "Volibear", "Warwick", "Wukong", "Xayah", "Xerath", "Xin Zhao", "Yasuo", "Yone", "Yorick", "Yuumi", "Zac", "Zed", "Zeri", "Ziggs", "Zilean", "Zoe", "Zyra" };

    protected override void OnInitialized()
    {
        string GetIcon(string n) => $"https://ddragon.leagueoflegends.com/cdn/14.1.1/img/spell/Summoner{n}.png";
        Spells = new Dictionary<string, Spell> { { "flash", new Spell { Name = "Flash", BaseCd = 300, IconUrl = GetIcon("Flash") } }, { "teleport", new Spell { Name = "Teleport", BaseCd = 360, IconUrl = GetIcon("Teleport") } }, { "ignite", new Spell { Name = "Ignite", BaseCd = 180, IconUrl = GetIcon("Dot") } }, { "heal", new Spell { Name = "Heal", BaseCd = 240, IconUrl = GetIcon("Heal") } }, { "exhaust", new Spell { Name = "Exhaust", BaseCd = 210, IconUrl = GetIcon("Exhaust") } }, { "ghost", new Spell { Name = "Ghost", BaseCd = 210, IconUrl = GetIcon("Haste") } }, { "smite", new Spell { Name = "Smite", BaseCd = 90, IconUrl = GetIcon("Smite") } }, { "barrier", new Spell { Name = "Barrier", BaseCd = 180, IconUrl = GetIcon("Barrier") } }, { "cleanse", new Spell { Name = "Cleanse", BaseCd = 210, IconUrl = GetIcon("Boost") } } };
        _ = RunTimer();
    }

    private int GetNextCannonTime()
    {
        int firstCannon = 155; // 2:35
        if (MatchSeconds < firstCannon) return firstCannon;
        int interval = MatchSeconds < 900 ? 90 : (MatchSeconds < 1500 ? 60 : 30);
        int elapsed = MatchSeconds - firstCannon;
        return firstCannon + ((elapsed / interval) + 1) * interval;
    }

    private string GetImminentClass(int? r) => r switch
    {
        <= 5 => "imminent-red bg-red-950/40",
        <= 20 => "imminent-yellow bg-yellow-950/40",
        _ => "border-slate-800 bg-slate-950"
    };

    private void AdjustSpell(LaneState lane, bool isS1, int delta)
    {
        if (isS1 && lane.Spell1Remaining.HasValue) { lane.Spell1Remaining = Math.Max(0, lane.Spell1Remaining.Value + delta); lane.Spell1ReadyAt = MatchSeconds + lane.Spell1Remaining.Value; }
        else if (!isS1 && lane.Spell2Remaining.HasValue) { lane.Spell2Remaining = Math.Max(0, lane.Spell2Remaining.Value + delta); lane.Spell2ReadyAt = MatchSeconds + lane.Spell2Remaining.Value; }
    }

    private void StartBuffTimer(bool b) { if (b) BlueBuffRemaining = 300; else RedBuffRemaining = 300; }
    private async Task RequestReset()
    {
        if (!ShowResetConfirm) { ShowResetConfirm = true; _confirmCts?.Cancel(); _confirmCts = new CancellationTokenSource(); try { await Task.Delay(3000, _confirmCts.Token); ShowResetConfirm = false; StateHasChanged(); } catch { } }
        else { _confirmCts?.Cancel(); IsTeamLocked = false; ShowResetConfirm = false; MatchSeconds = 0; BlueBuffRemaining = null; RedBuffRemaining = null; foreach (var l in Lanes) { l.Spell1Remaining = null; l.Spell2Remaining = null; l.UltLastUsed = null; } StateHasChanged(); }
    }
    private void HandleGlobalClick() { if (ShowResetConfirm) { _confirmCts?.Cancel(); ShowResetConfirm = false; } }
    private async Task ConfirmLock() { if (Lanes.Any(l => string.IsNullOrEmpty(l.SelectedSpell1Key) || string.IsNullOrEmpty(l.SelectedSpell2Key))) { await JS.InvokeVoidAsync("alert", "Select spells."); return; } IsTeamLocked = true; }
    private void StartTimer(LaneState lane, bool isS1)
    {
        var key = isS1 ? lane.SelectedSpell1Key : lane.SelectedSpell2Key;
        if (Spells.TryGetValue(key, out var s))
        {
            int cd = CalculateCd(s.BaseCd, lane.TotalHaste);
            int rem = Math.Max(0, cd - 1);
            if (isS1) { lane.Spell1Remaining = rem; lane.Spell1ReadyAt = MatchSeconds + rem; } else { lane.Spell2Remaining = rem; lane.Spell2ReadyAt = MatchSeconds + rem; }
        }
    }
    private async Task RunTimer()
    {
        try { using var timer = new PeriodicTimer(TimeSpan.FromSeconds(1)); while (await timer.WaitForNextTickAsync(_cts.Token)) { if (IsTeamLocked) { MatchSeconds++; if (BlueBuffRemaining > 0) BlueBuffRemaining--; else BlueBuffRemaining = null; if (RedBuffRemaining > 0) RedBuffRemaining--; else RedBuffRemaining = null; } foreach (var l in Lanes) { if (l.Spell1Remaining > 0) l.Spell1Remaining--; else l.Spell1Remaining = null; if (l.Spell2Remaining > 0) l.Spell2Remaining--; else l.Spell2Remaining = null; } await InvokeAsync(StateHasChanged); } }
        catch (OperationCanceledException) { }
    }
    private int CalculateCd(int b, int h) => (int)Math.Round(b / (1.0 + (h / 100.0)));
    private string FormatTime(int? s) => !s.HasValue ? "READY" : $"{(s.Value / 60)}:{(s.Value % 60):D2}";

    private string GetChampionImgUrl(string n)
    {
        if (string.IsNullOrWhiteSpace(n)) return "";
        string i = n.Replace("'", "").Replace(".", "").Replace("-", "").Replace(" ", "").Replace("&", "").ToLower();
        var special = new Dictionary<string, string> {
            {"wukong", "MonkeyKing"}, {"ksante", "KSante"}, {"belveth", "Belveth"}, {"leblanc", "Leblanc"},
            {"nunuwillump", "Nunu"}, {"renataglasc", "Renata"}, {"drmundo", "DrMundo"}, {"masteryi", "MasterYi"},
            {"aurelionsol", "AurelionSol"}, {"missfortune", "MissFortune"}, {"tahmkench", "TahmKench"},
            {"twistedfate", "TwistedFate"}, {"xinzhao", "XinZhao"}, {"khazix", "Khazix"},
            {"chogath", "Chogath"}, {"velkoz", "Velkoz"}, {"reksai", "RekSai"}, {"kogmaw", "KogMaw"},
            {"jarvaniv", "JarvanIV"}, {"jarvan4", "JarvanIV"}, {"jarvan", "JarvanIV"}
        };
        if (special.TryGetValue(i, out var m)) return $"https://ddragon.leagueoflegends.com/cdn/img/champion/loading/{m}_0.jpg";
        return $"https://ddragon.leagueoflegends.com/cdn/img/champion/loading/{char.ToUpper(i[0]) + i.Substring(1).ToLower()}_0.jpg";
    }

    public void Dispose() { _cts.Cancel(); _cts.Dispose(); _confirmCts?.Cancel(); _confirmCts?.Dispose(); }
}